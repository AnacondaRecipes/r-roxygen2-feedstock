From bd0875cc547ce390363eb0792e5212d9326fd4e2 Mon Sep 17 00:00:00 2001
From: hadley <h.wickham@gmail.com>
Date: Thu, 17 Aug 2017 09:53:02 -0500
Subject: [PATCH] Use pkgload

Fixes #568. Fixes #595.
---
 DESCRIPTION                      |  3 +++
 NEWS.md                          |  6 +++++
 R/source.R                       | 54 ++--------------------------------------
 man/source_package.Rd            |  5 +---
 roxygen.Rproj                    |  1 -
 tests/testthat/empty/DESCRIPTION |  3 ++-
 tests/testthat/test-namespace.R  |  2 +-
 7 files changed, 15 insertions(+), 59 deletions(-)

diff -urN roxygen2.orig/DESCRIPTION roxygen2/DESCRIPTION
--- roxygen2.orig/DESCRIPTION	2018-01-09 18:37:38.214986135 +0000
+++ roxygen2/DESCRIPTION	2018-01-09 18:40:24.177698589 +0000
@@ -13,8 +13,8 @@
     person("RStudio", role = "cph")
     )
 Depends: R (>= 3.0.2)
-Imports: stringr (>= 0.5), stringi, brew, digest, methods, Rcpp (>=
-        0.11.0), R6, desc, commonmark, xml2, utils
+Imports: stringr (>= 0.5), stringi, brew, digest, methods, pkgload,
+       Rcpp (>= 0.11.0), R6, desc, commonmark, xml2, utils
 Suggests: testthat (>= 0.8.0), knitr, devtools, rmarkdown, covr
 VignetteBuilder: knitr
 LinkingTo: Rcpp
diff -urN roxygen2.orig/man/source_package.Rd roxygen2/man/source_package.Rd
--- roxygen2.orig/man/source_package.Rd	2018-01-09 18:37:38.220985875 +0000
+++ roxygen2/man/source_package.Rd	2018-01-09 18:37:57.473068680 +0000
@@ -14,9 +14,6 @@
 sourced.
 }
 \description{
-This is a simple attempt to load code in a package used by
-\link{roxygenize}. It will work with simple packages, but fail if
-there are compiled files, data files, etc. In that case, it's better to
-use \link[devtools:document]{devtools::document}.
+This is a wrapper around \link[pkgload:load_all]{pkgload::load_all}
 }
 \keyword{internal}
diff -urN roxygen2.orig/NEWS.md roxygen2/NEWS.md
--- roxygen2.orig/NEWS.md	2018-01-09 18:37:38.221985841 +0000
+++ roxygen2/NEWS.md	2018-01-09 18:41:50.434067132 +0000
@@ -1,3 +1,11 @@
+# roxygen2 6.0.1-patched
+
+* `roxygenise()` uses `pkgload::load_all()` instead of a home grown solution
+  to simulate package loading (this is needed because roxygen2 uses run-time
+  information to generate the documetation). This should reduce S4 related
+  problems and ensures that `devtools::document()` and `roxygenise()` always
+  have exactly the same behaviour (#568, #595).
+
 # roxygen2 6.0.1
 
 * Allowing empty lines in .Rbuildignore. Previously, empty lines caused all 
diff -urN roxygen2.orig/R/source.R roxygen2/R/source.R
--- roxygen2.orig/R/source.R	2018-01-09 18:37:38.221985841 +0000
+++ roxygen2/R/source.R	2018-01-09 18:37:57.473068680 +0000
@@ -1,63 +1,13 @@
 #' Source all files in a package.
 #'
-#' This is a simple attempt to load code in a package used by
-#' [roxygenize]. It will work with simple packages, but fail if
-#' there are compiled files, data files, etc. In that case, it's better to
-#' use [devtools::document].
+#' This is a wrapper around [pkgload::load_all]
 #'
 #' @param path Path to a package.
 #' @return An environment, into which all R files in the directory were
 #'   sourced.
 #' @keywords internal
 source_package <- function(path) {
-  r_path <- file.path(path, "R")
-  if (!file.exists(r_path)) stop("Can't find R/ directory", call. = FALSE)
-
-  old_dir <- setwd(r_path)
-  on.exit(setwd(old_dir))
-
-  env <- new.env(parent = globalenv())
-  methods::setPackageName("roxygen_devtest", env)
-
-  load_pkg_dependencies(path)
-
-  desc <- read_pkg_description(path)
-  paths <- package_files(path)
-  lapply(paths, sys_source, envir = env, fileEncoding = desc$Encoding %||% "UTF-8")
-
-  env
-}
-
-sys_source <- function(file, envir = baseenv(), fileEncoding = "UTF-8") {
-  exprs <- parse(text = read_lines_enc(file, file_encoding = fileEncoding))
-  for (expr in exprs) {
-    eval(expr, envir = envir)
-  }
-  invisible()
-}
-
-# Assume that the package has already been loaded by other means
-# (e.g. build and reload)
-loaded_package <- function(path) {
-  desc <- file.path(path, "DESCRIPTION")
-  stopifnot(file.exists(desc))
-
-  package <- read.dcf(desc, fields = "Package")[[1, 1]]
-  asNamespace(package)
-}
-
-
-
-load_pkg_dependencies <- function(path) {
-  desc <- read_pkg_description(path)
-
-  pkgs <- paste(c(desc$Depends, desc$Imports), collapse = ", ")
-  if (pkgs == "") return()
-
-  pkgs <- str_replace_all(pkgs, "\\(.*?\\)", "")
-  pkgs <- str_split(pkgs, ",")[[1]]
-  pkgs <- str_trim(pkgs)
-  lapply(pkgs[pkgs != "R"], require, character.only = TRUE)
+  pkgload::load_all(path)$env
 }
 
 package_files <- function(path) {
diff -urN roxygen2.orig/tests/testthat/empty/DESCRIPTION roxygen2/tests/testthat/empty/DESCRIPTION
--- roxygen2.orig/tests/testthat/empty/DESCRIPTION	2018-01-09 18:37:38.217985991 +0000
+++ roxygen2/tests/testthat/empty/DESCRIPTION	2018-01-09 18:38:00.606082851 +0000
@@ -1 +1,2 @@
-Name: empty
+Package: empty
+Version: 1.0.0
diff -urN roxygen2.orig/tests/testthat/test-namespace.R roxygen2/tests/testthat/test-namespace.R
--- roxygen2.orig/tests/testthat/test-namespace.R	2018-01-09 18:37:38.215986083 +0000
+++ roxygen2/tests/testthat/test-namespace.R	2018-01-09 18:38:00.606082851 +0000
@@ -182,7 +182,7 @@
 })
 
 test_that("empty NAMESPACE generates zero-length vector", {
-  base_path <- normalizePath("empty")
+  base_path <- test_path("empty")
   parsed <- parse_package(base_path, source_package, registry = list())
 
   results <- roclet_process(namespace_roclet(), parsed, base_path)
